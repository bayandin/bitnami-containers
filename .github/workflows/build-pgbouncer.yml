name: Build PgBouncer

on:
  push:
    branches:
      - neon
  pull_request:
  workflow_dispatch:
    inputs:
      pgbouncer-repo:
        description: 'Repository to build PgBouncer from'
        default: "knizhnik/pgbouncer"
        required: true
      pgbouncer-commit:
        description: 'PgBouncer commit to build from'
        default: '619c661b18fe9d456f05cf50470b3f7edacdb13b'
        required: true
      push-to-docker-registry:
        description: 'Push the image to Docker Hub'
        type: boolean
        default: false
        required: true

defaults:
  run:
    shell: bash -euxo pipefail {0}
    working-directory: bitnami/pgbouncer/1/debian-11

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.ref_name == 'neon' && github.sha || 'anysha' }}
  cancel-in-progress: true

jobs:
  build-pgbouncer:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Build PgBouncer Image
        run: |
          docker build . \
            --build-arg PGBOUNCER_COMMIT=${PGBOUNCER_COMMIT} \
            --build-arg PGBOUNCER_REPO=${PGBOUNCER_REPO} \
            --build-arg GITHUB_RUN_ID=${GITHUB_RUN_ID} \
            --tag neondatabase/pgbouncer:${GITHUB_RUN_ID}
        env:
          PGBOUNCER_REPO: ${{ github.event.inputs.pgbouncer-repo || 'knizhnik/pgbouncer' }}
          PGBOUNCER_COMMIT: ${{ github.event.inputs.pgbouncer-commit || '619c661b18fe9d456f05cf50470b3f7edacdb13b' }}

      - name: Test PgBouncer Image
        run: |
          sed -i "s@image: docker.io/bitnami/pgbouncer:1@image: neondatabase/pgbouncer:${GITHUB_RUN_ID}@g" docker-compose-prepared.yml

          docker-compose -f docker-compose-prepared.yml up --detach
          until pg_isready; do
            echo "Waiting..."
            sleep 1
          done

          psql -- << 'EOF'
            CREATE TABLE x (x INT);
            INSERT INTO x SELECT * FROM generate_series(1, 100000);
            PREPARE xxx (int) as SELECT * FROM x WHERE x < $1;
            EXECUTE xxx(5);
          EOF

          psql -c 'EXECUTE xxx(10);'
        env:
          PGHOST: 127.0.0.1
          PGPORT: 6432
          PGDATABASE: postgres
          PGUSER: postgres

      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.NEON_DOCKERHUB_USERNAME }}
          password: ${{ secrets.NEON_DOCKERHUB_PASSWORD }}

      - name: Get Image Version
        id: build-tag
        run: |


      - name: Push PgBouncer Image
        if: ${{ github.event.inputs.push-to-docker-registry == 'true' || github.ref_name == 'neon' }}
        run: |
          CID=$(docker create neondatabase/pgbouncer:${GITHUB_RUN_ID})
          docker cp $CID:/opt/bitnami/pgbouncer/VERSION.txt ./VERSION.txt
          TAG=$(cat ./VERSION.txt)

          docker tag neondatabase/pgbouncer:${GITHUB_RUN_ID} neondatabase/pgbouncer:${TAG}
          docker push neondatabase/pgbouncer:${TAG}

          echo "neondatabase/pgbouncer:${TAG}" >> ${GITHUB_STEP_SUMMARY}
